// ==UserScript==
// @name         YouTube Better StartPage (YTBSP)
// @description  Spotlights all subscriptions in an organized fashion on the startpage of YouTube.
// @version      2.0.3
// @author       Nemo64, dzre, Crow08
// @namespace    ytbsp
// @include      https://youtube.com/*
// @include      https://www.youtube.com/*
// @require      https://apis.google.com/js/api.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.slim.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.21.0/moment.min.js
// @downloadURL  https://raw.githubusercontent.com/Crow08/YTBSP/master/dist/ytbsp.user.js
// @updateURL    https://raw.githubusercontent.com/Crow08/YTBSP/master/dist/ytbsp.meta.js
// @grant        none
// ==/UserScript==

/*
MIT License

Copyright (c) 2015-2019 (Crow08) \
Copyright (c) 2014 (dzre) \
Copyright (c) 2011-2013 Marco D. Pfeiffer (Nemo64) 

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
*/

/* global jQuery, $, gapi, GM_info */
window.moment = this.moment;
window.GoogleAuth = this.GoogleAuth;

function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}!function(){var t=function(){"use strict";function i(e){var t=this;_classCallCheck(this,i),this.videos=[],this.name=e.title,this.id=e.resourceId.channelId,this.isExpanded=!1,this.needsUpdate=!1,this.isInView=!1,this.lastViewCheck=0,this.row=$("<li/>",{class:"ytbsp-subscription",css:{display:l.hideEmptySubs?"none":""}});var n=$("<div/>",{class:"ytbsp-subMenuStrip"});n.append($("<div/>",{css:{float:"right"}}).append($("<button/>",{class:"ytbsp-func ytbsp-subRemoveAllVideos",html:"Remove all"}).click(function(){t.subRemoveAllVideos()})).append($("<button/>",{class:"ytbsp-func ytbsp-subResetAllVideos",html:"Reset all"}).click(function(){t.subResetAllVideos()})).append($("<button/>",{class:"ytbsp-func ytbsp-subSeenAllVideos",html:"Mark all as seen"}).click(function(){t.subSeenAllVideos()})).append($("<button/>",{class:"ytbsp-func ytbsp-subShowMore",html:"Show more"}).click(function(){t.subShowMore()}))),n.append($("<div/>",{class:"ytbsp-loaderDiv"}).append(E("loader_".concat(this.id)))),n.append($("<h3/>",{class:"ytbsp-subTitle"}).append($("<a/>",{href:"/channel/".concat(this.id)}).append(this.name))),this.row.append(n),this.videoList=$("<ul/>",{class:"ytbsp-subVids"}),this.row.append(this.videoList),B.append(this.row),this.updateSubVideos()}return _createClass(i,[{key:"subRemoveAllVideos",value:function(){var n=this;n.videos.forEach(function(e,t){n.videos[t].remove()}),n.buildSubList(),he()}},{key:"subResetAllVideos",value:function(){var n=this;n.videos.forEach(function(e,t){n.videos[t].reset()}),n.buildSubList(),he()}},{key:"subSeenAllVideos",value:function(){var n=this;n.videos.forEach(function(e,t){n.videos[t].see()}),n.buildSubList(),he()}},{key:"subShowMore",value:function(){var e=this;e.isExpanded=!e.isExpanded,e.isExpanded?$(".ytbsp-func.ytbsp-subShowMore",e.row).text("Show less"):$(".ytbsp-func.ytbsp-subShowMore",e.row).text("Show more"),e.buildSubList()}},{key:"updateSubVideos",value:function(){G(1,!1,this),z("GET","/youtube/v3/playlistItems",{maxResults:l.maxVidsPerSub,part:"snippet",fields:"items(snippet(publishedAt,resourceId/videoId,thumbnails(maxres,medium),title)),nextPageToken,pageInfo,prevPageToken",playlistId:this.id.replace(/^UC/,"UU")}).then(function(e){u.videos=[];var t=$.grep(D,function(e){return e.id===u.id}),c=[];1===t.length&&(c=t[0].videos);e.items.forEach(function(e){var t=null,n=null,i=null,s=null,a=null,o=null,r=null,p=null;Object.prototype.hasOwnProperty.call(e,"snippet")&&(Object.prototype.hasOwnProperty.call(e.snippet,"title")&&(i=e.snippet.title),Object.prototype.hasOwnProperty.call(e.snippet,"publishedAt")&&(s=window.moment(e.snippet.publishedAt).fromNow(),a=window.moment(e.snippet.publishedAt).format("YYYY-MM-DD HH:mm:ss")),Object.prototype.hasOwnProperty.call(e.snippet,"resourceId")&&Object.prototype.hasOwnProperty.call(e.snippet.resourceId,"videoId")&&(o=e.snippet.resourceId.videoId),Object.prototype.hasOwnProperty.call(e.snippet,"thumbnails")&&(Object.prototype.hasOwnProperty.call(e.snippet.thumbnails,"medium")&&Object.prototype.hasOwnProperty.call(e.snippet.thumbnails.medium,"url")&&(t=e.snippet.thumbnails.medium.url),Object.prototype.hasOwnProperty.call(e.snippet.thumbnails,"maxres")&&Object.prototype.hasOwnProperty.call(e.snippet.thumbnails.maxres,"url")&&(n=e.snippet.thumbnails.maxres.url)));var l=$.grep(c,function(e){return e.vid===o});1===l.length&&(Object.prototype.hasOwnProperty.call(l[0],"seen")&&(r=l[0].seen),Object.prototype.hasOwnProperty.call(l[0],"removed")&&(p=l[0].removed));var d={vid:o,title:i,thumb:t||"",thumbLarge:n||"",uploaded:s||"missing upload time",pubDate:a||"missing upload time",seen:r||!1,removed:p||!1};u.videos.push(new h(d))}),u.buildSubList(),G(-1,!1,u)});var u=this}},{key:"buildSubList",value:function(){var a=this,o=$(".ytbsp-video-item",this.videoList),r=0,p=this.isExpanded?l.maxVidsPerSub:l.maxVidsPerRow;$("br",this.videoList).remove(),this.videos.forEach(function(e,t){if(e.isRemoved()||l.hideSeenVideos&&e.isSeen()){var n=$("#YTBSPthumb_".concat(e.vid),this.videoList),i=o.index(n);n&&-1!==i&&(n.remove(),o.splice(i,1))}else if(r<p){var s=o[r];s&&s.id.substr(11)===e.vid?this.videos[t].updateThumb(this.isInView):(this.videos[t].createThumb(this.isInView),$(".ytbsp-seemarker",this.videos[t].thumbLi).click(function(){a.videos[t].toggleSeen(),a.buildSubList(),he()}),$(".ytbsp-x",this.videos[t].thumbLi).click(function(){a.videos[t].remove(),a.buildSubList(),he()}),r<o.length?(o[r].before(this.videos[t].thumbLi[0]),o.splice(r,0,this.videos[t].thumbLi)):(this.videoList.append(this.videos[t].thumbLi),o.push(this.videos[t].thumbLi))),++r<p&&0==r%l.maxVidsPerRow&&(r<o.length?$("</br>").insertBefore(o[r]):this.videoList.append($("</br>")))}},this);for(var e=r,t=o.length;e<t;++e)o[e].remove();this.isEmpty=r<=0,this.handleVisibility()}},{key:"handleVisibility",value:function(){this.isEmpty&&l.hideEmptySubs?this.row.hide():this.row.show(),fe()}},{key:"showLoader",value:function(){var e=$(".ytbsp-loaderDiv",this.row),t=$(".ytbsp-loader",this.row);e&&t&&(e.css("width","16px"),setTimeout(function(){t.css("opacity","1")},200))}},{key:"removeLoader",value:function(){var e=$(".ytbsp-loaderDiv",this.row),t=$(".ytbsp-loader",this.row);e&&t&&setTimeout(function(){t.css("opacity","0"),setTimeout(function(){e.css("width","0px")},200)},200)}},{key:"updateInView",value:function(e){if(!this.videoList.offset())return!1;if(e&&this.lastViewCheck>=e)return this.isInView;e&&(this.lastViewCheck=e);var t=this.videoList.offset().top,n=document.body.scrollTop||document.documentElement.scrollTop,i=n+window.innerHeight;return this.isInView=t-l.screenThreshold<i&&t+l.screenThreshold>n,this.isInView&&$("img[data-src]",this.videoList).each(function(){$(this).get(0).src=$(this).get(0).getAttribute("data-src"),$(this).get(0).removeAttribute("data-src")}),this.isInView}},{key:"getDTO",value:function(){var t={videos:[],id:this.id};return this.videos.forEach(function(e){t.videos.push(e.getDTO())}),t}}]),i}(),o={},h=function(){"use strict";function t(e){_classCallCheck(this,t),this.title="",this.thumb="",this.thumbLarge="",this.duration="0:00",this.uploaded="",this.pubDate="",this.clicks="",this.seen=!1,this.removed=!1,this.clipItem=null,this.closeItem=null,this.thumbItem=null,this.thumbLargeItem=null,this.durationItem=null,this.clicksItem=null,this.uploadItem=null,this.titleItem=null,this.vid=e.vid,this.addInfo(e),this.thumbLi=$("<li/>",{id:"YTBSPthumb_".concat(this.vid),class:"ytbsp-video-item"})}return _createClass(t,[{key:"addInfo",value:function(e){Object.prototype.hasOwnProperty.call(e,"title")&&(this.title=""!==e.title?e.title:this.title),Object.prototype.hasOwnProperty.call(e,"thumb")&&(this.thumb=""!==e.thumb?e.thumb:this.thumb),Object.prototype.hasOwnProperty.call(e,"thumbLarge")&&(this.thumbLarge=""!==e.thumbLarge?e.thumbLarge:this.thumbLarge),Object.prototype.hasOwnProperty.call(e,"duration")&&(this.duration="0:00"!==e.duration?e.duration:this.duration),Object.prototype.hasOwnProperty.call(e,"uploaded")&&(this.uploaded=""!==e.uploaded?e.uploaded:this.uploaded),Object.prototype.hasOwnProperty.call(e,"pubDate")&&(this.pubDate=""!==e.pubDate?e.pubDate:this.pubDate),Object.prototype.hasOwnProperty.call(e,"clicks")&&(this.clicks=""!==e.clicks?e.clicks:this.clicks),Object.prototype.hasOwnProperty.call(e,"seen")&&(this.seen=!1!==e.seen?e.seen:this.seen),Object.prototype.hasOwnProperty.call(e,"removed")&&(this.removed=!1!==e.removed?e.removed:this.removed)}},{key:"isRemoved",value:function(){return this.removed}},{key:"remove",value:function(){this.removed||(this.removed=!0)}},{key:"unremove",value:function(){this.removed&&(this.removed=!1)}},{key:"isSeen",value:function(){return this.seen}},{key:"toggleSeen",value:function(){this.seen?this.unsee():this.see()}},{key:"see",value:function(){this.seen||(this.seen=!0,this.updateThumb(!0))}},{key:"unsee",value:function(){this.seen&&(this.seen=!1,this.updateThumb(!0))}},{key:"reset",value:function(){this.unsee(),this.unremove()}},{key:"createThumb",value:function(i){var a=this;"0:00"===this.duration&&(G(1),z("GET","/youtube/v3/videos",{part:"contentDetails,statistics",fields:"items(contentDetails/duration,statistics/viewCount)",id:a.vid}).then(function(e){if(Object.prototype.hasOwnProperty.call(e,"items")&&1===e.items.length){if(Object.prototype.hasOwnProperty.call(e.items[0],"contentDetails")&&Object.prototype.hasOwnProperty.call(e.items[0].contentDetails,"duration")){var t=window.moment.duration(e.items[0].contentDetails.duration);0===t.hours()?a.duration=window.moment("".concat(t.minutes(),":").concat(t.seconds()),"m:s").format("mm:ss"):a.duration=window.moment("".concat(t.hours(),":").concat(t.minutes(),":").concat(t.seconds()),"h:m:s").format("HH:mm:ss")}if(Object.prototype.hasOwnProperty.call(e.items[0],"statistics")&&Object.prototype.hasOwnProperty.call(e.items[0].statistics,"viewCount")){var n=parseInt(e.items[0].statistics.viewCount,10);a.clicks=1e6<n?"".concat(Math.round(n/1e6*10)/10,"M views"):1e4<n?"".concat(Math.round(n/1e3),"K views"):"".concat(n," views")}}a.updateThumb(i),G(-1)})),this.clipItem=$("<a/>",{href:"/watch?v=".concat(this.vid),class:"ytbsp-clip","data-vid":this.vid}),this.closeItem=$("<div/>",{class:"ytbsp-x",html:"X"}),this.thumbItem=$("<img/>",{class:"ytbsp-thumb"}),this.durationItem=$("<ytd-thumbnail-overlay-time-status-renderer/>"),this.thumbLargeItem=$("<input/>",{class:"ytbsp-thumb-large-url",type:"hidden"}),this.titleItem=$("<a/>",{href:"/watch?v=".concat(this.vid),class:"ytbsp-title","data-vid":this.vid}),this.clicksItem=$("<p/>",{class:"ytbsp-views"}),this.uploadItem=$("<p/>",{class:"ytbsp-uploaded"}),this.seemarkerItem=$("<p/>",{class:"ytbsp-seemarker".concat(this.isSeen()?" seen":""),html:this.isSeen()?"already seen":"mark as seen"}),this.thumbLi.empty(),this.thumbLi.append(this.clipItem.append(this.closeItem).append(this.thumbItem).append(this.durationItem).append(this.thumbLargeItem)),this.thumbLi.append(this.titleItem),this.thumbLi.append(this.clicksItem),this.thumbLi.append(this.uploadItem),this.thumbLi.append(this.seemarkerItem);var e=me(),t=e?"#888888":"#11111199",n=e?"#ffffffff":"#141414";function s(){a.vid.replace("-","$")in o&&(clearTimeout(o[a.vid.replace("-","$")]),o[a.vid.replace("-","$")]=-1)}this.clicksItem.css("color",t),this.uploadItem.css("color",t),this.seemarkerItem.css("color",n),$(".ytbsp-clip, .ytbsp-title, .ytbsp-x",this.thumbLi).click(function(e){e.preventDefault(),e.target.classList.contains("ytbsp-x")||function(e){document.querySelector(p).fire("yt-navigate",{endpoint:{watchEndpoint:{videoId:e},webNavigationEndpointData:{url:"/watch?v=".concat(e),webPageType:"WATCH"}}})}($(this).attr("data-vid"))}),this.clipItem.mouseover(function(){if(!(l.enlargeFactor<=1)&&0===$(".ytbsp-x:hover",this).length){a.vid.replace("-","$")in o||(o[a.vid.replace("-","$")]=-1);var i=$(this).parent(),s=$(this);-1===o[a.vid.replace("-","$")]&&(o[a.vid.replace("-","$")]=setTimeout(function(){var e=$(".ytbsp-thumb",s),t=$(".ytbsp-title",i),n=$("p",i);e.attr("src",$(".ytbsp-thumb-large-url",s).val()),e.addClass("ytbsp-thumb-large"),e.css("width","".concat(160*l.enlargeFactor,"px")),e.css("height","".concat(90*l.enlargeFactor,"px")),t.addClass("ytbsp-title-large"),t.css("width","".concat(160*l.enlargeFactor-4,"px")),t.css("left","".concat(-(160*l.enlargeFactor/2-82),"px")),s.addClass("ytbsp-clip-large"),s.css("width","".concat(160*l.enlargeFactor+4,"px")),s.css("height","".concat(90*l.enlargeFactor+4,"px")),s.css("left","".concat(-(160*l.enlargeFactor/2-82),"px")),n.hide()},l.enlargeDelay))}}),this.thumbLi.mouseleave(function(){if(!(l.enlargeFactor<=1)){a.vid.replace("-","$")in o&&0<o[a.vid.replace("-","$")]&&clearTimeout(o[a.vid.replace("-","$")]),o[a.vid.replace("-","$")]=-1;var e=$(this),t=$(".ytbsp-clip",e),n=$(".ytbsp-thumb",t),i=$(".ytbsp-title",e),s=$("p",e);n.removeClass("ytbsp-thumb-large"),n.css("width",""),n.css("height",""),i.removeClass("ytbsp-title-large"),i.css("width",""),i.css("left",""),t.removeClass("ytbsp-clip-large"),t.css("width",""),t.css("height",""),t.css("left",""),s.show()}}),this.closeItem.mouseover(s),this.clipItem.mouseleave(s),this.updateThumb(i)}},{key:"updateThumb",value:function(e){this.thumbItem&&(e||this.thumbItem.src?this.thumbItem.attr("src",this.thumb):this.thumbItem.attr("data-src",this.thumb),this.thumbLargeItem.val(this.thumbLarge?this.thumbLarge:this.thumb),this.durationItem.html(this.duration),this.clicksItem.html(this.clicks),this.uploadItem.html(this.uploaded),this.titleItem.html(this.title),this.titleItem.prop("title",this.title),this.seen?(this.seemarkerItem.html("already seen"),this.seemarkerItem.addClass("seen")):(this.seemarkerItem.html("mark as seen"),this.seemarkerItem.removeClass("seen")))}},{key:"getDTO",value:function(){return{vid:this.vid,seen:this.seen,removed:this.removed}}}]),t}(),e=function(){"use strict";function e(){_classCallCheck(this,e),this.playerRef=null,this.nativePlayerParent=null,this.nativePlayerCss=null,this.nativePlayerIsTheater=!1,this.peekPlayerActive=!1}return _createClass(e,[{key:"showPeekPlayer",value:function(){if(this.playerRef=$(f),this.playerRef.length&&!(l.peekPlayerSizeFactor<=0)){this.nativePlayerParent=this.playerRef.parent(),null===this.nativePlayerCss&&(this.nativePlayerCss={position:this.playerRef.css("position"),right:this.playerRef.css("right"),bottom:this.playerRef.css("bottom"),width:this.playerRef.css("width"),height:this.playerRef.css("height"),zIndex:this.playerRef.css("zIndex")});try{this.nativePlayerIsTheater=$(g).get(0).theater,$(g).get(0).theaterModeChanged_(!0)}catch(e){console.warn("Unable to put player into theater mode.")}$("#YTBSP").append(this.playerRef),1===this.playerRef.get(0).getPlayerState()&&this.playerRef.get(0).playVideo(),this.playerRef.get(0).hideControls(),this.playerRef.css({position:"fixed",right:"20px",bottom:"20px",width:"".concat(320*l.peekPlayerSizeFactor,"px"),height:"".concat(180*l.peekPlayerSizeFactor,"px"),zIndex:"10"}),this.playerRef.append($("<div/>",{id:"ytbsp-peekplayer-overlay",css:{width:320*l.peekPlayerSizeFactor,height:180*l.peekPlayerSizeFactor}}).append($("<div/>",{id:"ytbsp-peekplayer-overlay-player-control",css:{width:320*l.peekPlayerSizeFactor/10,height:320*l.peekPlayerSizeFactor/10}}).append($("<label/>",{class:"ytbsp-play-pause-icon",title:"play / pause"})))),$(v).get(0).paused||$(".ytbsp-play-pause-icon").addClass("ytbsp-pause");var t=this;$("#ytbsp-peekplayer-overlay").click(function(e){0!==$("#ytbsp-peekplayer-overlay-player-control:hover").length?(t.playerRef.trigger("click"),$(".ytbsp-play-pause-icon").toggleClass("ytbsp-pause")):(e.preventDefault(),e.stopPropagation(),pe())}),window.dispatchEvent(new Event("resize")),this.peekPlayerActive=!0}}},{key:"showNativePlayer",value:function(){if(null!==this.nativePlayerParent&&this.nativePlayerParent.length&&(this.playerRef=$(f),this.playerRef.length)){if(this.nativePlayerParent.append($(f)),1===this.playerRef.get(0).getPlayerState()&&this.playerRef.get(0).playVideo(),this.playerRef.get(0).showControls(),this.playerRef.css(this.nativePlayerCss),window.dispatchEvent(new Event("resize")),!this.nativePlayerIsTheater)try{$(g).get(0).theaterModeChanged_(!1)}catch(e){console.warn("Unable to put player out of theater mode.")}$("#ytbsp-peekplayer-overlay").remove(),this.peekPlayerActive=!1}}},{key:"isPeekPlayerActive",value:function(){return this.peekPlayerActive}}]),e}(),n='#ytbsp-menuStrip {\n  white-space: nowrap;\n  padding: 10px 0px 20px 80px;\n  display: flex;\n}\n#ytbsp-subs {\n  overflow: visible;\n  padding: 0px;\n  width: fit-content;\n  margin: auto;\n  list-style-type: none;\n  min-width: 1512 px;\n  margin-bottom: 100px;\n}\n.ytbsp-subscription {\n  padding: 0 4px;\n  margin-top: -1px;\n  border-bottom-style: solid;\n  border-bottom-width: 1px;\n  border-top-style: solid;\n  border-top-width: 1px;\n}\n.ytbsp-dark-theme .ytbsp-subscription {\n  border-color: #2c2c2c;\n}\n.ytbsp-light-theme .ytbsp-subscription {\n  border-color: #e2e2e2;\n}\n.ytbsp-subVids {\n  padding: 0px;\n  margin: 10px 0;\n  -webkit-transition: height 5s;\n  -moz-transition: height 5s;\n  -o-transition: height 5s;\n}\n.ytbsp-video-item {\n  display: inline-block;\n  width: 160px;\n  height: 165px;\n  padding: 0 4px;\n  overflow: visible;\n  vertical-align: top;\n}\n.ytbsp-video-item .ytbsp-title {\n  display: block;\n  padding-top: 5px;\n  height: 3.2rem;\n  overflow: hidden;\n  text-decoration: none;\n  font-size: 1.4rem;\n  line-height: 1.6rem;\n  font-weight: 500;\n}\n.ytbsp-dark-theme .ytbsp-video-item .ytbsp-title {\n  color: #e1e1e1;\n}\n.ytbsp-light-theme .ytbsp-video-item .ytbsp-title {\n  color: #111111;\n}\n.ytbsp-subMenuStrip {\n  height: 25px;\n  margin: 4px 4px 3px;\n}\n.ytbsp-subTitle a {\n  padding-top: 6px;\n  position: absolute;\n  text-decoration: none;\n  font-size: 1.6rem;\n  font-weight: 500;\n}\n.ytbsp-dark-theme .ytbsp-subTitle a {\n  color: #e1e1e1;\n}\n.ytbsp-light-theme .ytbsp-subTitle a {\n  color: #111111;\n}\n#YTBSP {\n  margin-left: 240px;\n  margin-top: 57px;\n}\n#ytbsp-subs .ytbsp-title-large {\n  position: relative;\n  z-index: 1;\n  text-align: center;\n  border-width: 0px 2px 2px 2px;\n  border-style: solid;\n  padding: 2px;\n}\n.ytbsp-dark-theme #ytbsp-subs .ytbsp-title-large {\n  background: #252525;\n}\n.ytbsp-light-theme #ytbsp-subs .ytbsp-title-large {\n  background: #f5f5f5;\n}\n.ytbsp-dark-theme #ytbsp-subs .ytbsp-title-large {\n  border-color: #737373;\n}\n.ytbsp-light-theme #ytbsp-subs .ytbsp-title-large {\n  border-color: #737373;\n}\n.ytbsp-clip {\n  position: relative;\n  width: 160px;\n  height: 90px;\n  border: none;\n  cursor: pointer;\n  display: block;\n}\n.ytbsp-clip-large {\n  z-index: 1;\n  top: -45px;\n  margin-bottom: -44px;\n  border: none;\n}\n.ytbsp-x {\n  position: absolute;\n  z-index: 2;\n  top: 2%;\n  right: 1%;\n  opacity: 0;\n  width: 17px;\n  height: 17px;\n  line-height: 16px;\n  text-align: center;\n  background-color: #000;\n  color: #fff;\n  font-size: 15px;\n  font-weight: bold;\n  border-radius: 3px;\n  -moz-border-radius: 3px;\n  display: block;\n  cursor: pointer;\n}\n.ytbsp-video-item:hover .ytbsp-x {\n  opacity: 0.6;\n}\n.ytbsp-video-item:hover .ytbsp-x:hover {\n  opacity: 1;\n}\n.ytbsp-thumb {\n  display: block;\n  position: absolute;\n  height: 90px;\n  width: 160px;\n}\n.ytbsp-thumb-large {\n  top: 1px;\n  border-width: 2px;\n  border-style: solid;\n}\n.ytbsp-dark-theme .ytbsp-thumb-large {\n  border-color: #737373;\n}\n.ytbsp-light-theme .ytbsp-thumb-large {\n  border-color: #737373;\n}\n.ytbsp-views,\n.ytbsp-uploaded {\n  display: inline-block;\n  margin: 5px 0px 0px 0px;\n  font-size: 1.2rem;\n}\n.ytbsp-dark-theme .ytbsp-views,\n.ytbsp-dark-theme .ytbsp-uploaded {\n  color: #888888;\n}\n.ytbsp-light-theme .ytbsp-views,\n.ytbsp-light-theme .ytbsp-uploaded {\n  color: #11111199;\n}\n.ytbsp-views:after {\n  content: "•";\n  margin: 0 4px;\n}\n.ytbsp-seemarker {\n  font-size: 1.2rem;\n  background-color: transparent;\n  padding: 1px 0px;\n  margin: 5px 0px 0px 0px;\n  text-align: center;\n  opacity: 0.88;\n  cursor: pointer;\n  display: block;\n}\n.ytbsp-dark-theme .ytbsp-seemarker {\n  color: #ffffffff;\n}\n.ytbsp-light-theme .ytbsp-seemarker {\n  color: #141414;\n}\n.ytbsp-seemarker:hover {\n  opacity: 1;\n}\n.ytbsp-seemarker:active {\n  opacity: 0.4;\n}\n.ytbsp-seemarker.seen {\n  opacity: 1;\n  font-weight: 500;\n  background-color: #474747;\n}\n.ytbsp-seemarker.seen:hover {\n  opacity: 0.6;\n}\n.ytbsp-func {\n  cursor: pointer;\n  display: inline-block;\n  border: none;\n  z-index: 1;\n  opacity: 0.88;\n  background-color: transparent;\n  padding: 1px 10px;\n  margin: 0px 2px;\n  font-size: 1.4rem;\n  font-weight: 400;\n  font-family: Roboto, Noto, sans-serif;\n}\n.ytbsp-dark-theme .ytbsp-func {\n  color: #ffffffff;\n}\n.ytbsp-light-theme .ytbsp-func {\n  color: #141414;\n}\n.ytbsp-func:hover {\n  opacity: 1;\n}\n.ytbsp-func:active {\n  opacity: 0.6;\n}\nlabel.ytbsp-func {\n  padding-top: 3px;\n}\n.ytbsp-func:focus {\n  outline-style: none;\n}\n.ytbsp-func input {\n  vertical-align: middle;\n  margin: -2px 5px -1px 0px;\n}\n.ytbsp-loaderDiv {\n  float: left;\n  width: 16px;\n  height: 16px;\n  margin-right: 5px;\n  -webkit-transition: width 0.2s;\n  -moz-transition: width 0.2s;\n  -o-transition: width 0.2s;\n}\n#ytbsp-loaderSpan {\n  width: 21px;\n  margin-right: 1px;\n  display: inline-block;\n}\n#ytbsp-refresh {\n  display: none;\n  padding: 1px 3px;\n}\n.ytbsp-loader {\n  border: 3px solid #bbb;\n  border-top: 3px solid #555;\n  border-left: 3px solid #bbb;\n  border-bottom: 3px solid #555;\n  border-radius: 50%;\n  width: 10px;\n  height: 10px;\n  animation: spin 1s linear infinite;\n  -webkit-transition: opacity 0.2s;\n  -moz-transition: opacity 0.2s;\n  -o-transition: opacity 0.2s;\n}\n@keyframes spin {\n  0% {\n    transform: rotate(0deg);\n  }\n  100% {\n    transform: rotate(360deg);\n  }\n}\n.ytbsp-slider {\n  display: inline-block;\n  padding: 0px 10px;\n  width: 34px;\n  vertical-align: middle;\n  cursor: pointer;\n}\n.ytbsp-slider-rail {\n  position: absolute;\n  width: 34px;\n  height: 14px;\n  border-radius: 8px;\n  opacity: 0.2;\n  -webkit-transition: 0.1s;\n  transition: 0.1s;\n  background-color: #737373;\n}\n.ytbsp-slider-knob {\n  position: relative;\n  top: -3px;\n  left: 0;\n  height: 20px;\n  width: 20px;\n  border-radius: 50%;\n  background-color: #fff;\n  box-shadow: 0 1px 5px 0 rgba(0, 0, 0, 0.6);\n  -webkit-transition: 0.4s;\n  transition: 0.4s;\n}\n.ytbsp-slider-cb:checked ~ .ytbsp-slider-knob {\n  left: 16px;\n}\n.ytbsp-slider-cb:checked ~ .ytbsp-slider-rail {\n  opacity: 0.9;\n  -webkit-transition: 0.8s;\n  transition: 0.8s;\n}\n.ytbsp-dark-theme .ytbsp-slider-cb:checked ~ .ytbsp-slider-rail {\n  background-color: #e1e1e1;\n}\n.ytbsp-light-theme .ytbsp-slider-cb:checked ~ .ytbsp-slider-rail {\n  background-color: #111111;\n}\n.ytbsp-slider-cb {\n  display: none;\n}\n#ytbsp-modal {\n  position: fixed;\n  left: 0;\n  top: 0;\n  width: 100%;\n  height: 100%;\n  background-color: rgba(0, 0, 0, 0.4);\n  z-index: 3;\n  -webkit-transition: opacity 0.2s;\n  -moz-transition: opacity 0.2s;\n  -o-transition: opacity 0.2s;\n  opacity: 0;\n  overflow: auto;\n  display: none;\n}\n#ytbsp-modal-content {\n  margin: 0 auto;\n  width: 600px;\n  min-height: 20px;\n  margin-top: 30px;\n  padding: 10px;\n  position: sticky;\n  top: 60px;\n  -moz-border-radius: 3px;\n  border-radius: 3px;\n  box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);\n}\n.ytbsp-dark-theme #ytbsp-modal-content {\n  background: #252525;\n}\n.ytbsp-light-theme #ytbsp-modal-content {\n  background: #f5f5f5;\n}\n#ytbsp-modal-content textarea {\n  width: 595px;\n  height: 400px;\n  resize: none;\n  margin: 20px 0;\n}\n#ytbsp-modal-content p,\n#ytbsp-modal-content h1,\n#ytbsp-modal-content h2 {\n  font-weight: 400;\n}\n.ytbsp-dark-theme #ytbsp-modal-content p,\n.ytbsp-dark-theme #ytbsp-modal-content h1,\n.ytbsp-dark-theme #ytbsp-modal-content h2 {\n  color: #e1e1e1;\n}\n.ytbsp-light-theme #ytbsp-modal-content p,\n.ytbsp-light-theme #ytbsp-modal-content h1,\n.ytbsp-light-theme #ytbsp-modal-content h2 {\n  color: #111111;\n}\n#ytbsp-modal-content h2 {\n  display: inline-block;\n}\n#ytbsp-modal-end-div {\n  display: inline-block;\n  width: 100%;\n}\n#ytbsp-modal-end-div input {\n  float: right;\n}\n#ytbsp-settings-table {\n  margin: 50px 0px;\n  border-collapse: collapse;\n}\n.ytbsp-dark-theme #ytbsp-settings-table {\n  color: #e1e1e1;\n}\n.ytbsp-light-theme #ytbsp-settings-table {\n  color: #111111;\n}\n#ytbsp-settings-table tr {\n  min-height: 45px;\n  border-bottom-style: solid;\n  border-bottom-width: 1px;\n}\n.ytbsp-dark-theme #ytbsp-settings-table tr {\n  border-color: #2c2c2c;\n}\n.ytbsp-light-theme #ytbsp-settings-table tr {\n  border-color: #e2e2e2;\n}\n#ytbsp-settings-table td {\n  font-size: 1.4rem;\n  padding: 5px;\n  min-width: 80px;\n}\n#ytbsp-settings-table td:nth-child(3) {\n  font-size: 1rem;\n}\n#ytbsp-settings-table input[type="number"] {\n  width: 50px;\n}\n#ytbsp-peekplayer-overlay {\n  position: fixed;\n  right: 20px;\n  bottom: 20px;\n  z-index: 11;\n}\n#ytbsp-peekplayer-overlay-player-control {\n  position: absolute;\n  left: 0px;\n  bottom: 0px;\n  z-index: 12;\n  cursor: pointer;\n}\n.ytbsp-play-pause-icon {\n  cursor: pointer;\n  position: absolute;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  margin: auto;\n  width: 16px;\n  height: 24px;\n}\n.ytbsp-play-pause-icon::before,\n.ytbsp-play-pause-icon::after {\n  position: absolute;\n  top: 50%;\n  transform: translateY(-50%);\n}\n.ytbsp-play-pause-icon::before {\n  content: "";\n  left: 0;\n  transition: all 0.2s linear;\n  width: 0;\n  height: 12px;\n  border-top: 6px solid transparent;\n  border-bottom: 6px solid transparent;\n  border-left: 8px solid #ccc;\n}\n.ytbsp-play-pause-icon::after {\n  content: "";\n  right: 0;\n  transition: all 0.3s;\n  width: 0;\n  height: 0;\n  border-top: 6px solid transparent;\n  border-bottom: 6px solid transparent;\n  border-left: 8px solid #ccc;\n}\n.ytbsp-play-pause-icon.ytbsp-pause::before {\n  border-top-width: 0;\n  border-bottom-width: 0;\n  border-left-width: 5.3px;\n  height: 100%;\n}\n.ytbsp-play-pause-icon.ytbsp-pause::after {\n  border-top-width: 0;\n  border-bottom-width: 0;\n  border-left-width: 5.3px;\n  height: 100%;\n}\n',r={Ultra:"highres","2880p":"hd2880","2160p":"hd2160","1440p":"hd1440","1080p":"hd1080","720p":"hd720","480p":"large","360p":"medium","240p":"small","144p":"tiny"},l={useRemoteData:!0,maxSimSubLoad:10,maxVidsPerRow:9,maxVidsPerSub:36,enlargeDelay:500,enlargeFactor:2.8,enlargeFactorNative:2,timeToMarkAsSeen:10,screenThreshold:500,playerQuality:r["1080p"],peekPlayerSizeFactor:1.5,autoPauseVideo:!1,hideSeenVideos:!1,hideEmptySubs:!0},i="281397662073-jv0iupog9cdb0eopi3gu6ce543v0jo65.apps.googleusercontent.com",s=["https://www.googleapis.com/discovery/v1/apis/youtube/v3/rest","https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],a="https://www.googleapis.com/auth/youtube.readonly https://www.googleapis.com/auth/drive.appdata",p="ytd-app",d="#page-manager.ytd-app, #page-manager.ytd-app.style-scope",c="#info-contents > ytd-video-primary-info-renderer > div:last-child",u="#owner-name > a",b="#content",m="app-drawer#guide",y="yt-player-quality",f="#movie_player",g="#page-manager > ytd-watch-flexy",v=".video-stream",w="#info-contents > ytd-video-primary-info-renderer > div",x="".concat(d," { background: transparent; display:none; }"),S="".concat(d," { margin-top: -30px; margin-left: 120px; background: transparent; }\n    ").concat(m,"{ z-index: 0 !important;}"),k="".concat(d," { background: transparent; margin-top: 0px; }\n    ").concat(m,"{ z-index: 0 !important; width: var(--app-drawer-width, 256px); }"),P="".concat(d," { background: transparent; margin-top: -50px; }\n    ").concat(m,"{ z-index: 0; !important;}"),F="".concat(d," { background: transparent; }\n    ").concat(m,"{ z-index: 0; !important;}"),T="".concat(d," { background: transparent; margin-top: -60px; }\n    ").concat(m,"{ z-index: 0; !important;}\n    ").concat(d," ").concat("ytd-playlist-sidebar-renderer"," {padding-top: 54px;}"),D=[],I=null,V=!1;function E(e){return $("<div/>",{class:"ytbsp-loader",id:e})}function R(e,t,n){var i=$("<label/>",{class:"ytbsp-slider"});return i.append($("<input/>",{class:"ytbsp-slider-cb",type:"checkbox",id:e,checked:t,on:{change:n}})),i.append($("<div/>",{class:"ytbsp-slider-rail"})),i.append($("<div/>",{class:"ytbsp-slider-knob"})),i}var C=me()?"ytbsp-dark-theme":"ytbsp-light-theme",L=$("<div/>",{id:"YTBSP",class:C}),O=$("<div/>",{id:"ytbsp-menuStrip"});O.append($("<div/>",{id:"ytbsp-loaderSpan"}).append(E("ytbsp-main-loader")).append($("<button/>",{id:"ytbsp-refresh",class:"ytbsp-func",html:"&#x27F3;"}))),O.append($("<button/>",{id:"ytbsp-togglePage",class:"ytbsp-func",html:"Toggle YTBSP"})),O.append($("<button/>",{id:"ytbsp-removeAllVideos",class:"ytbsp-func ytbsp-hideWhenNative",html:"Remove all videos"})),O.append($("<button/>",{id:"ytbsp-resetAllVideos",class:"ytbsp-func ytbsp-hideWhenNative",html:"Reset all videos"})),O.append($("<button/>",{id:"ytbsp-backup",class:"ytbsp-func ytbsp-hideWhenNative",html:"Backup video info"})),O.append($("<label/>",{for:"ytbsp-hideSeenVideosCb",class:"ytbsp-func ytbsp-hideWhenNative"}).append($("<input/>",{id:"ytbsp-hideSeenVideosCb",type:"checkbox",checked:l.hideSeenVideos})).append("Hide seen videos")),O.append($("<label/>",{for:"ytbsp-hideEmptySubsCb",class:"ytbsp-func ytbsp-hideWhenNative"}).append($("<input/>",{id:"ytbsp-hideEmptySubsCb",type:"checkbox",checked:l.hideEmptySubs})).append("Hide empty subs")),O.append($("<button/>",{id:"ytbsp-settings",class:"ytbsp-func ytbsp-hideWhenNative",html:"&#x2699;"})),L.append(O),L.append($("<ul/>",{id:"ytbsp-subs",css:{"min-width":"".concat(168*l.maxVidsPerRow,"px")}})),L.append($("<div/>",{id:"ytbsp-modal"}).append($("<div/>",{id:"ytbsp-modal-content"})));var B=$("#ytbsp-subs",L);$(".ytbsp-hideWhenNative",L).css("visibility","hidden");var A=null,Y=null;be(x),l.timeToMarkAsSeen=localStorage.getItem("YTBSP_timeToMarkAsSeen"),l.autoPauseVideo="0"!==localStorage.getItem("YTBSP_autoPauseVideo"),gapi.load("client:auth2",function e(){gapi.client.init({clientId:i,discoveryDocs:s,scope:a}).then(function(){_<=0||(_=0,window.GoogleAuth=gapi.auth2.getAuthInstance(),M())},function(e){_<=0||(_=0,console.error("Google API client initialization failed:\n".concat(e)))});setTimeout(function(){--_<=0||e()},1e3)});var _=5;function M(){window.GoogleAuth.currentUser.get().hasGrantedScopes(a)?H():window.GoogleAuth.signIn().then(function(){H()},function(e){"popup_blocked_by_browser"===e.error?alert("please allow popups for this page and reload!"):console.error("Google user sign-in failed:\n".concat(e))})}function z(i,s,a,o){return new Promise(function(t,e){var n=function(e){for(var t in e)e[t]&&"undefined"!==e[t]||delete e[t];return e}(a);(o?gapi.client.request({body:o,method:i,path:s,params:n}):gapi.client.request({method:i,path:s,params:n})).execute(function(e){t(e)})})}var N=0,j=!1;function G(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1],n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;N+=e,j=j||t,null!==n&&(e<0?n.removeLoader():n.showLoader()),0===N?($(".ytbsp-loader","#ytbsp-loaderSpan").hide(),$("#ytbsp-refresh","#ytbsp-loaderSpan").show(),j&&(j=!1,he())):($(".ytbsp-loader","#ytbsp-loaderSpan").show(),$("#ytbsp-refresh","#ytbsp-loaderSpan").hide())}function H(){(function(){if(l.useRemoteData)return new Promise(function(n,e){G(1),z("GET","/drive/v3/files",{q:"name = 'YTBSP.json'",fields:"files(appProperties,id,name)",spaces:"appDataFolder"}).then(function(e){var t=e.files;t&&0<t.length?(I=t[0].id,l.useRemoteData="0"!==t[0].appProperties.useRemoteData,l.hideSeenVideos="0"!==t[0].appProperties.hideSeenVideos,l.hideEmptySubs="0"!==t[0].appProperties.hideEmptySubs,l.maxSimSubLoad=t[0].appProperties.maxSimSubLoad,l.maxVidsPerRow=t[0].appProperties.maxVidsPerRow,l.maxVidsPerSub=t[0].appProperties.maxVidsPerSub,l.enlargeDelay=t[0].appProperties.enlargeDelay,l.enlargeFactor=t[0].appProperties.enlargeFactor,l.enlargeFactorNative=t[0].appProperties.enlargeFactorNative,l.playerQuality=t[0].appProperties.playerQuality,l.timeToMarkAsSeen=t[0].appProperties.timeToMarkAsSeen,l.screenThreshold=t[0].appProperties.screenThreshold,l.autoPauseVideo="0"!==t[0].appProperties.autoPauseVideo,$("#ytbsp-hideSeenVideosCb").prop("checked",l.hideSeenVideos),$("#ytbsp-hideEmptySubsCb").prop("checked",l.hideEmptySubs)):W().then(function(){n()}),G(-1),n()})});return new Promise(function(e,t){l.useRemoteData="0"!==localStorage.getItem("YTBSP_useRemoteData"),l.hideSeenVideos="0"!==localStorage.getItem("YTBSP_hideSeenVideos"),l.hideEmptySubs="0"!==localStorage.getItem("YTBSP_hideEmptySubs"),l.maxSimSubLoad=localStorage.getItem("YTBSP_maxSimSubLoad"),l.maxVidsPerRow=localStorage.getItem("YTBSP_maxVidsPerRow"),l.maxVidsPerSub=localStorage.getItem("YTBSP_maxVidsPerSub"),l.enlargeDelay=localStorage.getItem("YTBSP_enlargeDelay"),l.enlargeFactor=localStorage.getItem("YTBSP_enlargeFactor"),l.enlargeFactorNative=localStorage.getItem("YTBSP_enlargeFactorNative"),l.playerQuality=localStorage.getItem("YTBSP_playerQuality"),l.timeToMarkAsSeen=localStorage.getItem("YTBSP_timeToMarkAsSeen"),l.screenThreshold=localStorage.getItem("YTBSP_screenThreshold"),l.autoPauseVideo="0"!==localStorage.getItem("YTBSP_autoPauseVideo"),$("#ytbsp-hideSeenVideosCb").prop("checked",l.hideSeenVideos),$("#ytbsp-hideEmptySubsCb").prop("checked",l.hideEmptySubs),e()})})().then(function(){!function(){(function(){var e=document.createElement("style");e.type="text/css",e.id="ytbsp-css",e.innerHTML=n,document.head.appendChild(e)})(),1<=l.enlargeFactorNative&&function(){var e=(me(),"#737373"),t=document.createElement("style");t.type="text/css",t.id="ytbsp-css-thumb",t.innerHTML="ytd-thumbnail:hover { transform: scale(".concat(l.enlargeFactorNative,"); border: solid ").concat(l.enlargeFactorNative/2,"px ").concat(e,"; padding: 0px; z-index: 2; }")+"ytd-thumbnail { padding: ".concat(l.enlargeFactorNative/2,"px }")+"#video-title { width: 200px; }#scroll-container.yt-horizontal-list-renderer { overflow: visible; }",document.head.appendChild(t)}();localStorage.setItem(y,'{"data":"'.concat(l.playerQuality,'","expiration":').concat(window.moment().add(1,"months").valueOf(),',"creation":').concat(window.moment().valueOf(),"}"))}(),new Promise(function(t,e){q().then(function(e){D=e,t()})}).then(function(){G(1),z("GET","/youtube/v3/subscriptions",{mine:"true",part:"snippet",maxResults:l.maxSimSubLoad,fields:"items(snippet(resourceId/channelId,title)),nextPageToken,pageInfo,prevPageToken"}).then(ne)})})}function Q(){return new Promise(function(n,e){G(1),z("GET","/drive/v3/files",{q:"name = 'YTBSP.json'",fields:"files(id)",spaces:"appDataFolder"}).then(function(e){var t=e.files;t&&0<t.length?I=t[0].id:W().then(function(){n()}),G(-1),n()})})}function W(){return new Promise(function(t,e){G(1),z("POST","/drive/v3/files",{fields:"appProperties,id,name"},{parents:["appDataFolder"],name:"YTBSP.json",appProperties:{useRemoteData:l.useRemoteData,hideSeenVideos:l.hideSeenVideos,hideEmptySubs:l.hideEmptySubs,maxSimSubLoad:l.maxSimSubLoad,maxVidsPerRow:l.maxVidsPerRow,maxVidsPerSub:l.maxVidsPerSub,enlargeDelay:l.enlargeDelay,enlargeFactor:l.enlargeFactor,enlargeFactorNative:l.enlargeFactorNative,playerQuality:l.playerQuality,timeToMarkAsSeen:l.timeToMarkAsSeen,screenThreshold:l.screenThreshold,autoPauseVideo:l.autoPauseVideo}}).then(function(e){I=e.id,$("#ytbsp-hideSeenVideosCb").prop("checked",l.hideSeenVideos),$("#ytbsp-hideEmptySubsCb").prop("checked",l.hideEmptySubs),G(-1,!0),t()})})}function q(){return l.useRemoteData?U():J()}function U(){return new Promise(function(t,e){null===I?Q().then(function(){U().then(function(e){t(e)})}):z("GET","/drive/v3/files/".concat(I),{alt:"media"}).then(function(e){null==e||""===e?(console.error("Error parsing video information!"),t([])):t(e)})})}function J(){return new Promise(function(e,t){var n=localStorage.getItem("YTBSP");if("1"===localStorage.getItem("YTBSPcorruptcache")&&(console.warn("cache corruption detected!"),console.warn("restoring old cache..."),n=localStorage.getItem("YTBSPbackup")),null===n||""===n)n=[];else try{n=JSON.parse(n)}catch(e){console.error("Error parsing cache!"),n=[]}e(n)})}function K(){return l.useRemoteData?new Promise(function(e,t){X().then(function(){(function n(){return new Promise(function(e,t){null===I?Q().then(function(){n().then(function(){e()})}):z("PATCH","/drive/v3/files/".concat(I),{},{appProperties:{useRemoteData:l.useRemoteData?"1":"0",hideSeenVideos:l.hideSeenVideos?"1":"0",hideEmptySubs:l.hideEmptySubs?"1":"0",maxSimSubLoad:l.maxSimSubLoad,maxVidsPerRow:l.maxVidsPerRow,maxVidsPerSub:l.maxVidsPerSub,enlargeDelay:l.enlargeDelay,enlargeFactor:l.enlargeFactor,enlargeFactorNative:l.enlargeFactorNative,playerQuality:l.playerQuality,timeToMarkAsSeen:l.timeToMarkAsSeen,screenThreshold:l.screenThreshold,autoPauseVideo:l.autoPauseVideo?"1":"0"}}).then(function(){localStorage.setItem("YTBSP_useRemoteData",l.useRemoteData?"1":"0"),e()})})})().then(function(){e()})})}):X()}function X(){return new Promise(function(e,t){localStorage.setItem("YTBSP_useRemoteData",l.useRemoteData?"1":"0"),localStorage.setItem("YTBSP_hideSeenVideos",l.hideSeenVideos?"1":"0"),localStorage.setItem("YTBSP_hideEmptySubs",l.hideEmptySubs?"1":"0"),localStorage.setItem("YTBSP_maxSimSubLoad",l.maxSimSubLoad),localStorage.setItem("YTBSP_maxVidsPerRow",l.maxVidsPerRow),localStorage.setItem("YTBSP_maxVidsPerSub",l.maxVidsPerSub),localStorage.setItem("YTBSP_enlargeDelay",l.enlargeDelay),localStorage.setItem("YTBSP_enlargeFactor",l.enlargeFactor),localStorage.setItem("YTBSP_enlargeFactorNative",l.enlargeFactorNative),localStorage.setItem("YTBSP_playerQuality",l.playerQuality),localStorage.setItem("YTBSP_timeToMarkAsSeen",l.timeToMarkAsSeen),localStorage.setItem("YTBSP_screenThreshold",l.screenThreshold),localStorage.setItem("YTBSP_autoPauseVideo",l.autoPauseVideo?"1":"0"),e()})}function Z(){return new Promise(function(e,t){if(null===I)Q().then(function(){Z().then(function(){e()})});else{var n=JSON.stringify(D),i="-------314159265358979323846",s="\r\n--".concat(i,"\r\n"),a="\r\n--".concat(i,"--"),o=btoa(encodeURIComponent(n).replace(/%([0-9A-F]{2})/g,function(e,t){return String.fromCharCode("0x"+t)})),r="".concat(s,"Content-Type: application/json\r\n\r\n").concat(JSON.stringify({})).concat(s,"Content-Type: ").concat("text/plain","\r\n")+"Content-Transfer-Encoding: base64\r\n"+"\r\n".concat(o).concat(a);gapi.client.request({path:"/upload/drive/v3/files/".concat(I),method:"PATCH",params:{uploadType:"multipart",alt:"json"},headers:{"Content-Type":'multipart/mixed; boundary="'.concat(i,'"')},body:r}).execute(function(){e()})}})}function ee(){return new Promise(function(e,t){var n=JSON.stringify(D);localStorage.setItem("YTBSPcorruptcache",1),localStorage.setItem("YTBSP",n);var i=localStorage.getItem("YTBSP");n===i?(localStorage.setItem("YTBSPcorruptcache",0),localStorage.setItem("YTBSPbackup",n)):(console.error("cache save error!"),t(new Error("cache save error!"))),i=n=null,e()})}l.useRemoteData="0"!==localStorage.getItem("YTBSP_useRemoteData");var te=[];function ne(e){if(Object.prototype.hasOwnProperty.call(e,"error"))return console.error("OAuth failed! retrying..."),window.GoogleAuth.disconnect(),M(),void G(-1);void 0!==e.nextPageToken&&null!==e.nextPageToken&&(G(1),z("GET","/youtube/v3/subscriptions",{mine:"true",part:"snippet",maxResults:l.maxSimSubLoad,pageToken:e.nextPageToken,fields:"items(snippet(resourceId/channelId,title)),nextPageToken,pageInfo,prevPageToken"}).then(ne)),e.items.forEach(function(e){te.push(new t(e.snippet))}),G(-1)}function ie(e){0!==e.pageInfo.totalResults&&e.items.forEach(function(e){te.push(new t(e.snippet))}),G(-1,!0)}function se(){setTimeout(function(){te.forEach(function(e,t){te[t].updateSubVideos()})},0)}$(".ytbsp-func#ytbsp-refresh",L).click(se);var ae=!1;function oe(){($(d).show(),B.hide(),$(".ytbsp-hideWhenNative",L).css("visibility","hidden"),V=!0,ae)&&document.querySelector("ytd-app").fire("yt-guide-toggle",{})}function re(){($(d).hide(),B.show(),$(".ytbsp-hideWhenNative",L).css("visibility",""),V=!1,ae)&&(document.querySelector("ytd-app").fire("yt-guide-toggle",{}),setTimeout(function(){$("body").attr("style","overflow: auto")},200))}function pe(){V?(re(),/^\/?watch$/.test(location.pathname)&&ce.showPeekPlayer()):(oe(),/^\/?watch$/.test(location.pathname)&&ce.showNativePlayer())}function le(e){var t=$("#ytbsp-modal-content"),n=$("#ytbsp-modal");0!==t.length&&0!==n.length?(t.empty(),t.append(e),n.css("display","block"),setTimeout(function(){n.css("opacity","1")},0)):console.error("could not open modal!")}function de(){var e=$("#ytbsp-modal");0!==e.length&&(e.css("display","none"),e.css("opacity","0"))}$(".ytbsp-func#ytbsp-togglePage",L).click(pe),$(".ytbsp-func#ytbsp-removeAllVideos",L).click(function(){confirm("delete all videos?")&&(G(1),setTimeout(function(){var i=[];te.forEach(function(e,n){e.videos.forEach(function(e,t){te[n].videos[t].isRemoved()||(te[n].videos[t].remove(),i.push(n))})}),i.forEach(function(e){te[e].buildSubList()}),G(-1,!0)},0))}),$(".ytbsp-func#ytbsp-resetAllVideos",L).click(function(){confirm("reset all videos?")&&(G(1),setTimeout(function(){var i=[];te.forEach(function(e,n){e.videos.forEach(function(e,t){(te[n].videos[t].isRemoved()||te[n].videos[t].isSeen())&&(te[n].videos[t].reset(),i.push(n))})}),i.forEach(function(e){te[e].buildSubList()}),G(-1,!0)},0))}),$("#ytbsp-hideSeenVideosCb",L).change(function(){l.hideSeenVideos=!l.hideSeenVideos,G(1),K().then(function(){G(-1)}),te.forEach(function(e,t){te[t].buildSubList()}),$("#ytbsp-hideSeenVideosCb",L).prop("checked",l.hideSeenVideos)}),$("#ytbsp-hideEmptySubsCb",L).change(function(){l.hideEmptySubs=!l.hideEmptySubs,G(1),K().then(function(){G(-1)}),te.forEach(function(e,t){te[t].handleVisibility()}),$("#ytbsp-hideEmptySubsCb",L).prop("checked",l.hideEmptySubs)}),$(".ytbsp-func#ytbsp-backup",L).click(function(){G(1),q().then(function(e){le(function(e){var t=$("<div/>");t.append($("<h1/>",{html:"Backup video information"})),t.append($("<p/>",{html:"This Feature allows you to save which videos you have seen and removed and import them again on another browser/computer or just to make save you don't loose this information over night."})),t.append($("<h1/>",{html:"How do I do this?"})),t.append($("<p/>",{html:"Just copy the content of the following text box and save it somewhere.<br />To import it again copy it into the text box and press import data."})),t.append($("<p/>",{html:"The save data from local storage and Google Drive are compatible and interchangeable."})),t.append($("<textarea/>",{id:"ytbsp-export-import-textarea",html:e}));var n=$("<div/>",{id:"ytbsp-modal-end-div"});return n.append($("<h2/>",{html:"Local Storage"})),n.append(R("ytbsp-backup-switch",l.useRemoteData,function(){$("#ytbsp-backup-switch").prop("checked")?($("#ytbsp-export-import-textarea").empty(),G(1),U().then(function(e){$("#ytbsp-export-import-textarea").val(JSON.stringify(e)),G(-1)})):J().then(function(e){$("#ytbsp-export-import-textarea").val(JSON.stringify(e)),G(-1)})})),n.append($("<h2/>",{html:"Google Drive"})),n.append($("<input/>",{type:"submit",class:"ytbsp-func",value:"close",on:{click:de}})),n.append($("<input/>",{type:"submit",class:"ytbsp-func",value:"import data",on:{click:function(){G(1),D=JSON.parse($("#ytbsp-export-import-textarea").val()),$("#ytbsp-backup-switch").prop("checked")?Z().then(function(){de(),G(-1),location.reload()}):ee().then(function(){setTimeout(function(){de(),G(-1),location.reload()},200)})}}})),t.append(n)}(JSON.stringify(e))),G(-1)})}),$(".ytbsp-func#ytbsp-settings",L).click(function(){G(1),setTimeout(function(){le(function(){var e=$("<div/>");e.append($("<h1/>",{html:"Settings"}));var t=$("<table/>",{id:"ytbsp-settings-table"});t.append($("<tr>").append($("<td>",{html:"Hide empty subs"})).append($("<td>").append(R("ytbsp-settings-hideEmptySubs",l.hideEmptySubs))).append($("<td>"))),t.append($("<tr>").append($("<td>",{html:"Hide seen videos"})).append($("<td>").append(R("ytbsp-settings-hideSeenVideos",l.hideSeenVideos))).append($("<td>"))),t.append($("<tr>").append($("<td>",{html:"Use Google Drive"})).append($("<td>").append(R("ytbsp-settings-useRemoteData",l.useRemoteData))).append($("<td>"),{html:"Allows synchronization between browsers. May result in slower loading times."})),t.append($("<tr>").append($("<td>",{html:"Auto pause videos"})).append($("<td>").append(R("ytbsp-settings-autoPauseVideo",l.autoPauseVideo))).append($("<td>"),{html:"Open Videos in a paused state. (Does not effect playlists.)"}));var n=$("<Select>",{id:"ytbsp-settings-playerQuality"});for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&n.append($("<option>",{value:r[i],html:i}));n.val(l.playerQuality),t.append($("<tr>").append($("<td>",{html:"Player Quality"})).append($("<td>").append(n)).append($("<td>"),{html:"Open Videos in a paused state. (Does not effect playlists.)"})),t.append($("<tr>").append($("<td>",{html:"Max number of subscriptions loading simultaneously"})).append($("<td>").append($("<input>",{type:"number",min:"1",max:"50",id:"ytbsp-settings-maxSimSubLoad",value:l.maxSimSubLoad}))).append($("<td>",{html:"Default: 10 | Range: 1-50 | Higher numbers result in slower loading of single items but overall faster loading."}))),t.append($("<tr>").append($("<td>",{html:"Max number of videos per row"})).append($("<td>").append($("<input>",{type:"number",min:"1",max:"50",id:"ytbsp-settings-maxVidsPerRow",value:l.maxVidsPerRow}))).append($("<td>",{html:"Default: 9 | Range: 1-50"}))),t.append($("<tr>").append($("<td>",{html:"Max number of videos per subscription"})).append($("<td>").append($("<input>",{type:"number",min:"1",max:"50",id:"ytbsp-settings-maxVidsPerSub",value:l.maxVidsPerSub}))).append($("<td>",{html:"Default: 27 | Range: 1-50 | Should be dividable by videos per row."}))),t.append($("<tr>").append($("<td>",{html:"Watch time to mark video as seen"})).append($("<td>").append($("<input>",{type:"number",min:"0",id:"ytbsp-settings-timeToMarkAsSeen",value:l.timeToMarkAsSeen})).append(" s")).append($("<td>",{html:"Default: 10"}))),t.append($("<tr>").append($("<td>",{html:"Delay for thumbnail enlarge"})).append($("<td>").append($("<input>",{type:"number",min:"0",id:"ytbsp-settings-enlargeDelay",value:l.enlargeDelay})).append(" ms")).append($("<td>",{html:"Default: 500"}))),t.append($("<tr>").append($("<td>",{html:"Factor to enlarge thumbnail by"})).append($("<td>").append($("<input>",{type:"number",min:"1",step:"0.01",id:"ytbsp-settings-enlargeFactor",value:l.enlargeFactor}))).append($("<td>",{html:"Default: 2.8 | 1 : disable thumbnail enlarge"}))),t.append($("<tr>").append($("<td>",{html:"Factor to enlarge native thumbnail by"})).append($("<td>").append($("<input>",{type:"number",min:"1",step:"0.01",id:"ytbsp-settings-enlargeFactorNative",value:l.enlargeFactorNative}))).append($("<td>",{html:"Default: 2.0 | 1 : disable thumbnail enlarge"}))),t.append($("<tr>").append($("<td>",{html:"threshold to preload thumbnails"})).append($("<td>").append($("<input>",{type:"number",min:"0",id:"ytbsp-settings-screenThreshold",value:l.screenThreshold})).append(" px")).append($("<td>",{html:"Default: 500 | Higher threshold results in slower loading and more network traffic. Lower threshold may cause thumbnails to not show up immediately."}))),e.append(t);var s="";try{s=GM_info&&GM_info.script?"script version:".concat(GM_info.script.version):""}catch(e){console.info("Tampermonkey variables not available.")}var a=$("<div/>",{id:"ytbsp-modal-end-div"}).append($("<a/>",{html:"https://github.com/Crow08/YTBSP",href:"https://github.com/Crow08/YTBSP",target:"_blank",class:"ytbsp-func",style:"font-size: 1rem;"})).append($("<p/>",{html:s,class:"ytbsp-func",style:"font-size: 1rem;"})).append($("<input/>",{type:"submit",class:"ytbsp-func",value:"Cancel",on:{click:de}})).append($("<input/>",{type:"submit",class:"ytbsp-func",value:"Save",on:{click:function(){G(1),l.useRemoteData=$("#ytbsp-settings-useRemoteData").prop("checked"),l.hideEmptySubs=$("#ytbsp-settings-hideEmptySubs").prop("checked"),l.hideSeenVideos=$("#ytbsp-settings-hideSeenVideos").prop("checked"),l.maxSimSubLoad=$("#ytbsp-settings-maxSimSubLoad").val(),l.maxVidsPerRow=$("#ytbsp-settings-maxVidsPerRow").val(),l.maxVidsPerSub=$("#ytbsp-settings-maxVidsPerSub").val(),l.timeToMarkAsSeen=$("#ytbsp-settings-timeToMarkAsSeen").val(),l.enlargeDelay=$("#ytbsp-settings-enlargeDelay").val(),l.enlargeFactor=$("#ytbsp-settings-enlargeFactor").val(),l.enlargeFactorNative=$("#ytbsp-settings-enlargeFactorNative").val(),l.playerQuality=$("#ytbsp-settings-playerQuality").val(),l.screenThreshold=$("#ytbsp-settings-screenThreshold").val(),l.autoPauseVideo=$("#ytbsp-settings-autoPauseVideo").prop("checked"),K().then(function(){setTimeout(function(){de(),G(-1),location.reload()},200)})}}}));return e.append(a)}()),G(-1)},1)});var ce=new e,ue=[];function he(){for(var e,t=function(t){return 0!==$.grep(te,function(e){return e.id===t}).length},n=0;n<D.length;n++)if(!ue.includes(D[n].id)&&!t(D[n].id))return e=D[n].id,G(1),z("GET","/youtube/v3/subscriptions",{mine:"true",part:"snippet",forChannelId:e,fields:"items(snippet(resourceId/channelId,title)),pageInfo"}).then(ie),void ue.push(D[n].id);ue=[];var i=[];te.forEach(function(e){i.push(e.getDTO())}),D=i,l.useRemoteData?new Promise(function(e,t){ee().then(function(){Z().then(function(){e()})})}):ee()}function be(e){$("#ytbsp-yt-css").remove();var t=document.createElement("style");t.type="text/css",t.id="ytbsp-yt-css",t.innerHTML=e,document.head.appendChild(t)}function me(){var e=getComputedStyle(document.documentElement).backgroundColor.match(/\([\t-\r \xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF]*([0-9]+)[\t-\r \xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF]*,[\t-\r \xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF]*([0-9]+)[\t-\r \xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF]*,[\t-\r \xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF]*([0-9]+)/);return document.documentElement.getAttribute("dark")||e&&parseInt(e[1],10)+parseInt(e[2],10)+parseInt(e[3],10)<384}var ye=0;function fe(){0!==ye?ye=2:(ye=1,setTimeout(function(){var t=Date.now();te.forEach(function(e){e.updateInView(t)}),2===ye?(ye=0,fe()):ye=0},0))}function ge(){Y=!/(?:[\0-\t\x0B\f\x0E-\u2027\u202A-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])*watch\?(?:[\0-\t\x0B\f\x0E-\u2027\u202A-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])+list=(?:[\0-\t\x0B\f\x0E-\u2027\u202A-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])+/.test(location)&&l.autoPauseVideo,clearTimeout(A),ae=!1,window.dispatchEvent(new Event("resize")),/^(\/?|((\/feed\/)(trending|[s\u017F]ub[s\u017F]cription[s\u017F]|hi[s\u017F]tory)\/?))?$/i.test(location.pathname)?be(S):/^\/?watch$/.test(location.pathname)?(be(k),function(){var e=document.createElement("style");e.type="text/css",e.innerHTML="".concat(w,"{display: none;}").concat(c," {display: block;}"),document.head.appendChild(e)}(),A=setTimeout(function(){var i=location.href.match(/v=((?:[\0-%'-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF]){11})/)[1];if(i){var t=$(u).attr("href").match(/\/channel\/((?:[\0-%'-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])*)/)[1];te.forEach(function(e,n){e.id===t&&e.videos.forEach(function(e,t){e.vid===i&&(te[n].videos[t].see(),te[n].buildSubList(),he())})})}},1e3*l.timeToMarkAsSeen)):/^\/?results$/.test(location.pathname)?be(P):/^\/?playlist$/.test(location.pathname)?be(T):be(F),ce.isPeekPlayerActive()&&ce.showNativePlayer(),1<location.pathname.length?(oe(),/^\/?watch$/.test(location.pathname)&&(ae=!0)):re()}window.addEventListener("scroll",fe,!1),window.addEventListener("resize",fe,!1);var ve=document.location.href,we=new MutationObserver(function(){ve!==document.location.href&&(ve=document.location.href,ge()),0===L.parent().length&&0!==$(b).length&&($(b).prepend(L),$(window).scrollTop(0)),0!==$(g).length&&!0===$(g).get(0).fullscreen?L.hide():L.show()});$(window).bind("storage",function(e){"YTBSP"===e.key&&J().then(function(e){D=e,se()})}),$(document).ready(function(){$(d).hide(),we.observe(document.querySelector("body"),{childList:!0,subtree:!0}),ge(),$("html").removeClass("m0")});var xe=HTMLMediaElement.prototype.play;HTMLMediaElement.prototype.play=function(){if(jQuery.isReady)if(Y){Y=!1;var e=this.parentElement.parentElement;e&&e.pauseVideo()}else xe.call(this)}}(window.unsafeWindow||window);